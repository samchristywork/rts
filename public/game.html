<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RTS Game</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <canvas id="canvas" width="800" height="600" style="border: 1px solid black;"></canvas>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const params = new URLSearchParams(window.location.search);
    const gameId = params.get('id');
    const socket = io();

    function renderGame(game) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      game.entities.forEach(entity => {
        if (entity.type === 'base') {
          ctx.fillStyle = '#8B4513';
          ctx.fillRect(entity.position.x, entity.position.y, 40, 40);
          ctx.strokeStyle = '#000';
          ctx.strokeRect(entity.position.x, entity.position.y, 40, 40);
        } else if (entity.type === 'worker') {
          ctx.fillStyle = '#4169E1';
          ctx.beginPath();
          ctx.arc(entity.position.x, entity.position.y, 8, 0, Math.PI * 2);
          ctx.fill();
          ctx.stroke();
        } else if (entity.type === 'resource') {
          ctx.fillStyle = '#FFD700';
          ctx.beginPath();
          ctx.arc(entity.position.x, entity.position.y, 12, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = '#000';
          ctx.stroke();
        }

        ctx.fillStyle = '#000';
        ctx.font = '10px Arial';
        ctx.fillText(`${entity.id}`, entity.position.x - 5, entity.position.y - 10);

        if (entity.type === 'resource') {
          ctx.fillText(`${entity.value}`, entity.position.x - 10, entity.position.y + 20);
        } else if (entity.type === 'base') {
          ctx.fillText(`${entity.storedResources}/${entity.resourceCapacity}`, entity.position.x - 5, entity.position.y + 50);
        } else if (entity.type === 'worker') {
          ctx.fillText(`${entity.carrying}`, entity.position.x - 5, entity.position.y + 15);
        }
      });
    }

    async function loadGame() {
      const response = await fetch(`/api/games/${encodeURIComponent(gameId)}`);
      const game = await response.json();
      renderGame(game);
    }

    socket.on(`game:${gameId}`, (game) => {
      renderGame(game);
    });

    canvas.addEventListener('click', async (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const action = {
        type: 'move',
        entityId: 4,
        x: x,
        y: y
      };

      await fetch(`/api/games/${encodeURIComponent(gameId)}/action`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(action)
      });
    });

    loadGame();
  </script>
</body>
</html>
