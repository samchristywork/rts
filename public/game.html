<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RTS Game</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <canvas id="canvas" width="800" height="600" style="border: 1px solid black;"></canvas>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const params = new URLSearchParams(window.location.search);
    const gameId = params.get('id');
    const socket = io();

    function renderGame(game) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      game.entities.forEach(entity => {
        if (entity.type === 'base') {
          ctx.fillStyle = '#8B4513';
          ctx.fillRect(entity.position.x, entity.position.y, 40, 40);
          ctx.strokeStyle = '#000';
          ctx.strokeRect(entity.position.x, entity.position.y, 40, 40);
        } else if (entity.type === 'worker') {
          ctx.fillStyle = '#4169E1';
          ctx.beginPath();
          ctx.arc(entity.position.x, entity.position.y, 8, 0, Math.PI * 2);
          ctx.fill();
          ctx.stroke();
        } else if (entity.type === 'resource') {
          ctx.fillStyle = '#FFD700';
          ctx.beginPath();
          ctx.arc(entity.position.x, entity.position.y, 12, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = '#000';
          ctx.stroke();
        } else if (entity.type === 'melee') {
          ctx.fillStyle = '#DC143C';
          ctx.beginPath();
          ctx.arc(entity.position.x, entity.position.y, 10, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = '#000';
          ctx.stroke();
        } else if (entity.type === 'ranged') {
          ctx.fillStyle = '#32CD32';
          ctx.fillRect(entity.position.x - 8, entity.position.y - 8, 16, 16);
          ctx.strokeStyle = '#000';
          ctx.strokeRect(entity.position.x - 8, entity.position.y - 8, 16, 16);
        }

        ctx.fillStyle = '#000';
        ctx.font = '10px Arial';
        ctx.fillText(`${entity.id}`, entity.position.x - 5, entity.position.y - 10);

        if (entity.type === 'resource') {
          ctx.fillText(`${entity.value}`, entity.position.x - 10, entity.position.y + 20);
        } else if (entity.type === 'base') {
          ctx.fillText(`${entity.storedResources}/${entity.resourceCapacity}`, entity.position.x - 5, entity.position.y + 50);

          if (entity.currentBuild) {
            const percent = Math.floor((entity.buildProgress / entity.currentBuild.buildTime) * 100);
            ctx.fillText(`Building: ${entity.currentBuild.unitType} ${percent}%`, entity.position.x - 5, entity.position.y + 60);
          }

          if (entity.buildQueue.length > 0) {
            ctx.fillText(`Queue: ${entity.buildQueue.length}`, entity.position.x - 5, entity.position.y + 70);
          }
        } else if (entity.type === 'worker') {
          ctx.fillText(`${entity.carrying}`, entity.position.x - 5, entity.position.y + 15);
        }
      });
    }

    async function loadGame() {
      const response = await fetch(`/api/games/${encodeURIComponent(gameId)}`);
      const game = await response.json();
      renderGame(game);
      runAI(game);
    }

    const workerAssignments = {};

    function runAI(game) {
      const workers = game.entities.filter(e => e.type === 'worker');
      const resources = game.entities.filter(e => e.type === 'resource' && e.value > 0);
      const base = game.entities.find(e => e.type === 'base');

      if (!base || resources.length === 0) return;

      const resourcesByDistance = resources.map(r => {
        const dx = r.position.x - base.position.x;
        const dy = r.position.y - base.position.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        return { resource: r, distance };
      }).sort((a, b) => a.distance - b.distance);

      const closestResource = resourcesByDistance[0].resource;

      workers.forEach(worker => {
        if (!worker.harvestState) {
          if (!workerAssignments[worker.id] || !resources.find(r => r.id === workerAssignments[worker.id])) {
            workerAssignments[worker.id] = closestResource.id;

            const action = {
              type: 'harvest',
              entityId: worker.id,
              resourceId: closestResource.id,
              dropoffId: base.id
            };

            fetch(`/api/games/${encodeURIComponent(gameId)}/action`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(action)
            });
          }
        }
      });

      if (base.storedResources >= 5 && base.buildQueue.length === 0 && !base.currentBuild) {
        const action = {
          type: 'build',
          entityId: base.id,
          unitType: 'worker'
        };

        fetch(`/api/games/${encodeURIComponent(gameId)}/action`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(action)
        });
      }
    }

    socket.on(`game:${gameId}`, (game) => {
      renderGame(game);
      runAI(game);
    });

    canvas.addEventListener('click', async (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const action = {
        type: 'move',
        entityId: 4,
        x: x,
        y: y
      };

      await fetch(`/api/games/${encodeURIComponent(gameId)}/action`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(action)
      });
    });

    loadGame();
  </script>
</body>
</html>
